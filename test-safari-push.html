<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>üß™ Teste Push - Safari/Apple</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #030303;
      color: #fff;
    }
    button {
      background: #ff6b00;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      margin: 10px 0;
    }
    button:hover {
      background: #e55f00;
    }
    #log {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .success { color: #0f0; }
    .error { color: #f00; }
    .info { color: #00f; }
  </style>
</head>
<body>
  <h1>üß™ Teste de Push - Safari/Apple</h1>
  <p><strong>User ID:</strong> <code>5b90424c-f023-4a7d-a96a-5d62425ccb6f</code></p>
  
  <button onclick="checkPermission()">1Ô∏è‚É£ Verificar Permiss√£o</button>
  <button onclick="checkServiceWorker()">2Ô∏è‚É£ Verificar Service Worker</button>
  <button onclick="checkSubscription()">3Ô∏è‚É£ Verificar Inscri√ß√£o</button>
  <button onclick="testLocalNotification()">4Ô∏è‚É£ Teste Local (App Aberto)</button>
  <button onclick="sendRemotePush()">5Ô∏è‚É£ Enviar Push via API</button>
  <button onclick="clearLog()">üóëÔ∏è Limpar Log</button>
  
  <div id="log"></div>

  <script>
    const USER_ID = '5b90424c-f023-4a7d-a96a-5d62425ccb6f';
    const API_URL = 'https://ym-sports.vercel.app/api';

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
      logDiv.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(`[${type.toUpperCase()}]`, message);
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    async function checkPermission() {
      log('üîç Verificando permiss√£o de notifica√ß√µes...', 'info');
      
      if (!('Notification' in window)) {
        log('‚ùå Este navegador n√£o suporta notifica√ß√µes!', 'error');
        return;
      }

      log(`üìã Permiss√£o atual: ${Notification.permission}`, 'info');

      if (Notification.permission === 'granted') {
        log('‚úÖ Permiss√£o concedida!', 'success');
      } else if (Notification.permission === 'denied') {
        log('‚ùå Permiss√£o NEGADA! Resetar nas configura√ß√µes do navegador.', 'error');
      } else {
        log('‚ö†Ô∏è Permiss√£o ainda n√£o solicitada. Solicitando agora...', 'info');
        const result = await Notification.requestPermission();
        log(`üìã Nova permiss√£o: ${result}`, result === 'granted' ? 'success' : 'error');
      }
    }

    async function checkServiceWorker() {
      log('üîç Verificando Service Worker...', 'info');
      
      if (!('serviceWorker' in navigator)) {
        log('‚ùå Service Worker n√£o suportado!', 'error');
        return;
      }

      try {
        const registrations = await navigator.serviceWorker.getRegistrations();
        log(`üìã Service Workers registrados: ${registrations.length}`, 'info');
        
        for (let reg of registrations) {
          log(`  ‚Ä¢ Scope: ${reg.scope}`, 'info');
          log(`  ‚Ä¢ Estado: ${reg.active ? 'Ativo ‚úÖ' : 'Inativo ‚ùå'}`, reg.active ? 'success' : 'error');
          
          if (reg.pushManager) {
            const subscription = await reg.pushManager.getSubscription();
            if (subscription) {
              log(`  ‚Ä¢ Push: Inscrito ‚úÖ`, 'success');
              log(`  ‚Ä¢ Endpoint: ${subscription.endpoint.substring(0, 50)}...`, 'info');
            } else {
              log(`  ‚Ä¢ Push: N√ÉO inscrito ‚ùå`, 'error');
            }
          }
        }

        if (registrations.length === 0) {
          log('‚ö†Ô∏è Nenhum Service Worker registrado!', 'error');
          log('üí° V√° para https://ym-sports.vercel.app e ative as notifica√ß√µes', 'info');
        }
      } catch (error) {
        log(`‚ùå Erro ao verificar SW: ${error.message}`, 'error');
      }
    }

    async function checkSubscription() {
      log('üîç Verificando inscri√ß√£o no Supabase...', 'info');
      
      try {
        const response = await fetch('https://qfnjgksvpjbuhzwuitzg.supabase.co/rest/v1/push_subscriptions?user_id=eq.' + USER_ID, {
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmbmpna3N2cGpidWh6d3VpdHpnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODQ5NjYsImV4cCI6MjA3NDc2MDk2Nn0.ZW-a1HlOCgzM1QwNW3o55Ik83Cve_ClfT7hJbKEus_0'
          }
        });

        if (response.ok) {
          const data = await response.json();
          if (data.length > 0) {
            log(`‚úÖ Inscri√ß√£o encontrada no Supabase!`, 'success');
            log(`  ‚Ä¢ ID: ${data[0].id}`, 'info');
            log(`  ‚Ä¢ Endpoint: ${data[0].endpoint.substring(0, 60)}...`, 'info');
            log(`  ‚Ä¢ Criado: ${new Date(data[0].created_at).toLocaleString()}`, 'info');
          } else {
            log(`‚ùå Nenhuma inscri√ß√£o no Supabase para este usu√°rio!`, 'error');
          }
        } else {
          log(`‚ùå Erro ao buscar inscri√ß√£o: HTTP ${response.status}`, 'error');
        }
      } catch (error) {
        log(`‚ùå Erro: ${error.message}`, 'error');
      }
    }

    async function testLocalNotification() {
      log('üß™ Testando notifica√ß√£o local...', 'info');
      
      if (Notification.permission !== 'granted') {
        log('‚ùå Permiss√£o n√£o concedida!', 'error');
        return;
      }

      try {
        const notification = new Notification('üß™ Teste Local - YM Sports', {
          body: 'Esta √© uma notifica√ß√£o de teste LOCAL (n√£o via push)',
          icon: 'https://ym-sports.vercel.app/icons/logo.png',
          badge: 'https://ym-sports.vercel.app/icons/logo.png',
          tag: 'test-local',
          requireInteraction: false
        });

        notification.onclick = () => {
          log('üñ±Ô∏è Notifica√ß√£o clicada!', 'success');
          notification.close();
        };

        log('‚úÖ Notifica√ß√£o local enviada! Voc√™ deve v√™-la agora.', 'success');
      } catch (error) {
        log(`‚ùå Erro ao enviar notifica√ß√£o local: ${error.message}`, 'error');
      }
    }

    async function sendRemotePush() {
      log('üì° Enviando push notification via API...', 'info');
      
      try {
        const response = await fetch(`${API_URL}/send-notification-to-user`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            user_id: USER_ID,
            title: 'üöÄ Push Remoto - YM Sports',
            body: 'Esta √© uma notifica√ß√£o PUSH real via Service Worker!',
            url: '/dashboard',
            icon: '/icons/logo.png',
            data: {
              type: 'test',
              timestamp: Date.now()
            }
          })
        });

        const result = await response.json();
        
        if (result.success) {
          log(`‚úÖ Push enviado com sucesso!`, 'success');
          log(`  ‚Ä¢ Enviados: ${result.sent}`, 'success');
          log(`  ‚Ä¢ Falhas: ${result.failed}`, result.failed > 0 ? 'error' : 'info');
          log('üëÄ Voc√™ deve receber a notifica√ß√£o agora (mesmo com app fechado)!', 'info');
        } else {
          log(`‚ùå Falha ao enviar: ${result.message || 'Erro desconhecido'}`, 'error');
        }
      } catch (error) {
        log(`‚ùå Erro ao enviar push: ${error.message}`, 'error');
      }
    }

    // Log inicial
    log('üéØ Ferramenta de Debug para Push Notifications', 'info');
    log('üì± Navegador: ' + navigator.userAgent.split(' ').pop(), 'info');
    log('', 'info');
    log('üëÜ Clique nos bot√µes acima para testar cada etapa', 'info');
  </script>
</body>
</html>
