name: NotificaÃ§Ãµes de Eventos (CalendÃ¡rio)

on:
  schedule:
    # Verificar eventos a cada 5 minutos
    - cron: '*/5 * * * *'
  
  # Permitir execuÃ§Ã£o manual
  workflow_dispatch:

jobs:
  check-events:
    runs-on: ubuntu-latest
    
    steps:
      - name: Buscar eventos prÃ³ximos
        id: events
        run: |
          # Data/hora atual e daqui 30 minutos
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          IN_30MIN=$(date -u -d "+30 minutes" +"%Y-%m-%dT%H:%M:%S.000Z")
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” BUSCANDO EVENTOS PRÃ“XIMOS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“… PerÃ­odo: $NOW atÃ© $IN_30MIN"
          echo ""
          
          # Buscar eventos do Supabase
          EVENTS=$(curl -s -X GET \
            "${{ secrets.SUPABASE_URL }}/rest/v1/events?start_date=gte.$NOW&start_date=lte.$IN_30MIN&select=*" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json")
          
          echo "ğŸ“¦ Resposta do Supabase:"
          echo "$EVENTS"
          echo ""
          
          # Verificar se houve erro
          if echo "$EVENTS" | grep -q "message"; then
            echo "âš ï¸ Erro ao buscar eventos (API key invÃ¡lida ou sem permissÃ£o)"
            echo "   Usando lista vazia como fallback..."
            EVENTS='[]'
            EVENT_COUNT=0
          else
            EVENT_COUNT=$(echo "$EVENTS" | jq '. | length' 2>/dev/null || echo "0")
          fi
          
          echo "events=$EVENTS" >> $GITHUB_OUTPUT
          echo "count=$EVENT_COUNT" >> $GITHUB_OUTPUT
          echo "âœ… Eventos encontrados: $EVENT_COUNT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Enviar notificaÃ§Ãµes de eventos
        if: steps.events.outputs.count > 0
        env:
          EVENTS: ${{ steps.events.outputs.events }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ PROCESSANDO EVENTOS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          SENT_COUNT=0
          
          echo "$EVENTS" | jq -c '.[]' 2>/dev/null | while read event; do
            USER_ID=$(echo "$event" | jq -r '.user_id')
            EVENT_ID=$(echo "$event" | jq -r '.id')
            TITLE=$(echo "$event" | jq -r '.title')
            START_DATE=$(echo "$event" | jq -r '.start_date')
            LOCATION=$(echo "$event" | jq -r '.location // ""')
            
            # Calcular minutos atÃ© o evento
            NOW_EPOCH=$(date +%s)
            EVENT_EPOCH=$(date -d "$START_DATE" +%s)
            MINUTES_UNTIL=$(( ($EVENT_EPOCH - $NOW_EPOCH) / 60 ))
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“… EVENTO: $TITLE"
            echo "â° ComeÃ§a em: $MINUTES_UNTIL minutos"
            echo "ğŸ‘¤ UsuÃ¡rio: ${USER_ID:0:36}"
            echo "ğŸ†” Evento ID: ${EVENT_ID:0:36}"
            
            # Determinar mensagem baseada no tempo
            if [ $MINUTES_UNTIL -le 5 ]; then
              EMOJI="ğŸš¨"
              MESSAGE="Faltam apenas $MINUTES_UNTIL minutos!"
            elif [ $MINUTES_UNTIL -le 15 ]; then
              EMOJI="âš ï¸"
              MESSAGE="ComeÃ§a em $MINUTES_UNTIL minutos"
            else
              EMOJI="ğŸ“…"
              MESSAGE="ComeÃ§a em $MINUTES_UNTIL minutos"
            fi
            
            # Adicionar localizaÃ§Ã£o se existir
            if [ ! -z "$LOCATION" ] && [ "$LOCATION" != "null" ]; then
              MESSAGE="$MESSAGE - Local: $LOCATION"
            fi
            
            FULL_TITLE="$EMOJI $TITLE"
            
            echo "ğŸ“¤ Enviando: $FULL_TITLE"
            echo "ğŸ’¬ Mensagem: $MESSAGE"
            echo ""
            
            # Enviar notificaÃ§Ã£o
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST https://ym-sports.vercel.app/api/notify \
              -H "Content-Type: application/json" \
              -d "{
                \"user_id\": \"$USER_ID\",
                \"title\": \"$FULL_TITLE\",
                \"body\": \"$MESSAGE\",
                \"url\": \"/dashboard/calendar\"
              }")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | head -n-1)
            
            if [ "$HTTP_CODE" = "200" ]; then
              SENT=$(echo "$BODY" | jq -r '.sent // 0' 2>/dev/null || echo "0")
              FAILED=$(echo "$BODY" | jq -r '.failed // 0' 2>/dev/null || echo "0")
              echo "âœ… HTTP $HTTP_CODE - Enviadas: $SENT, Falharam: $FAILED"
              SENT_COUNT=$((SENT_COUNT + 1))
            else
              echo "âŒ HTTP $HTTP_CODE - Erro ao enviar"
              echo "   Resposta: $BODY"
            fi
            
            echo ""
            sleep 1
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RESUMO"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… NotificaÃ§Ãµes enviadas: $SENT_COUNT"
          echo "ğŸ‰ Processamento concluÃ­do!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Log resultado
        if: always()
        run: |
          echo "ğŸ“Š Resumo da VerificaÃ§Ã£o:"
          echo "â° HorÃ¡rio UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŒ HorÃ¡rio BRT: $(TZ=America/Sao_Paulo date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“… Eventos prÃ³ximos: ${{ steps.events.outputs.count }}"
          echo "âœ… VerificaÃ§Ã£o concluÃ­da!"

