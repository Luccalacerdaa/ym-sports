name: Notifica√ß√µes Di√°rias Autom√°ticas

on:
  schedule:
    # Hor√°rios em UTC (Brasil = UTC-3)
    # 07:00 BRT = 10:00 UTC
    - cron: '0 10 * * *'  # 07:00 BRT - Bom dia
    # 09:00 BRT = 12:00 UTC
    - cron: '0 12 * * *'  # 09:00 BRT - Hidrata√ß√£o
    # 11:30 BRT = 14:30 UTC
    - cron: '30 14 * * *' # 11:30 BRT - Treino manh√£
    # 14:00 BRT = 17:00 UTC
    - cron: '0 17 * * *'  # 14:00 BRT - Hidrata√ß√£o
    # 17:00 BRT = 20:00 UTC
    - cron: '0 20 * * *'  # 17:00 BRT - Treino tarde ‚≠ê
    # 19:00 BRT = 22:00 UTC
    - cron: '0 22 * * *'  # 19:00 BRT - Hidrata√ß√£o
    # 21:00 BRT = 00:00 UTC (dia seguinte)
    - cron: '0 0 * * *'   # 21:00 BRT - Boa noite
  
  # Permitir execu√ß√£o manual
  workflow_dispatch:
    inputs:
      notification_type:
        description: 'Tipo de notifica√ß√£o'
        required: true
        default: 'test'
        type: choice
        options:
          - morning
          - hydration
          - workout
          - evening
          - test

jobs:
  send-notification:
    runs-on: ubuntu-latest
    
    steps:
      - name: Identificar hor√°rio e tipo de notifica√ß√£o
        id: notification
        run: |
          HOUR=$(date -u +%H)
          
          case $HOUR in
            10) TYPE="morning"; TITLE="üí™ Bom dia, atleta!"; BODY="Hora de come√ßar o dia com energia! Vamos treinar hoje?"; URL="/dashboard" ;;
            12) TYPE="hydration"; TITLE="üíß Hidrata√ß√£o"; BODY="J√° bebeu √°gua hoje? Mantenha-se hidratado!"; URL="/dashboard/nutrition" ;;
            14) TYPE="workout"; TITLE="üèãÔ∏è Hora do Treino!"; BODY="Seu treino est√° te esperando. Vamos nessa!"; URL="/dashboard/training" ;;
            17) TYPE="hydration"; TITLE="üíß Hidrata√ß√£o"; BODY="Continue bebendo √°gua! Seu corpo agradece."; URL="/dashboard/nutrition" ;;
            20) TYPE="workout"; TITLE="üèÉ‚Äç‚ôÇÔ∏è Treino da Tarde!"; BODY="Que tal um treino agora? Voc√™ consegue!"; URL="/dashboard/training" ;;
            22) TYPE="hydration"; TITLE="üíß √öltima Hidrata√ß√£o"; BODY="Beba mais √°gua antes de dormir!"; URL="/dashboard/nutrition" ;;
            0)  TYPE="evening"; TITLE="üåô Boa Noite!"; BODY="Descanse bem para conquistar seus objetivos amanh√£!"; URL="/dashboard/motivational" ;;
            *)  TYPE="test"; TITLE="üß™ Teste"; BODY="Notifica√ß√£o autom√°tica funcionando!"; URL="/dashboard" ;;
          esac
          
          # Se for execu√ß√£o manual, usar input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TYPE="${{ github.event.inputs.notification_type }}"
            case $TYPE in
              morning) TITLE="üí™ Bom dia, atleta!"; BODY="Hora de come√ßar o dia com energia!"; URL="/dashboard" ;;
              hydration) TITLE="üíß Hidrata√ß√£o"; BODY="J√° bebeu √°gua hoje?"; URL="/dashboard/nutrition" ;;
              workout) TITLE="üèãÔ∏è Treino!"; BODY="Seu treino est√° te esperando!"; URL="/dashboard/training" ;;
              evening) TITLE="üåô Boa Noite!"; BODY="Descanse bem!"; URL="/dashboard/motivational" ;;
              test) TITLE="üß™ Teste Manual"; BODY="GitHub Actions funcionando!"; URL="/dashboard" ;;
            esac
          fi
          
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "body=$BODY" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "üîî Tipo: $TYPE | T√≠tulo: $TITLE"

      - name: Buscar todos os usu√°rios ativos
        id: users
        run: |
          # Buscar usu√°rios do Supabase
          RESPONSE=$(curl -s -X GET \
            "${{ secrets.SUPABASE_URL }}/rest/v1/profiles?select=user_id" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}")
          
          echo "users=$RESPONSE" >> $GITHUB_OUTPUT
          echo "üìä Usu√°rios encontrados"

      - name: Enviar notifica√ß√µes via API
        env:
          NOTIFICATION_TYPE: ${{ steps.notification.outputs.type }}
          NOTIFICATION_TITLE: ${{ steps.notification.outputs.title }}
          NOTIFICATION_BODY: ${{ steps.notification.outputs.body }}
          NOTIFICATION_URL: ${{ steps.notification.outputs.url }}
          USERS: ${{ steps.users.outputs.users }}
        run: |
          echo "üöÄ Enviando notifica√ß√µes..."
          echo "üìã Tipo: $NOTIFICATION_TYPE"
          echo "üìù T√≠tulo: $NOTIFICATION_TITLE"
          
          # Parse users JSON e enviar para cada um
          echo "$USERS" | jq -r '.[].user_id' | while read user_id; do
            if [ ! -z "$user_id" ]; then
              echo "üì§ Enviando para usu√°rio: ${user_id:0:20}..."
              
              RESPONSE=$(curl -s -X POST https://ym-sports.vercel.app/api/notify \
                -H "Content-Type: application/json" \
                -d "{
                  \"user_id\": \"$user_id\",
                  \"title\": \"$NOTIFICATION_TITLE\",
                  \"body\": \"$NOTIFICATION_BODY\",
                  \"url\": \"$NOTIFICATION_URL\"
                }")
              
              echo "‚úÖ Resposta: $RESPONSE"
              sleep 1  # Evitar rate limiting
            fi
          done
          
          echo "üéâ Notifica√ß√µes enviadas com sucesso!"

      - name: Log resultado
        if: always()
        run: |
          echo "üìä Resumo da Execu√ß√£o:"
          echo "‚è∞ Hor√°rio UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "üåé Hor√°rio BRT: $(TZ=America/Sao_Paulo date '+%Y-%m-%d %H:%M:%S')"
          echo "üîî Tipo: ${{ steps.notification.outputs.type }}"
          echo "üìù T√≠tulo: ${{ steps.notification.outputs.title }}"
          echo "‚úÖ Workflow conclu√≠do!"

