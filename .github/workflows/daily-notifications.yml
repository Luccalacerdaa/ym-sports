name: Notificaรงรตes Diรกrias Automรกticas

on:
  schedule:
    # Horรกrios em UTC (Brasil = UTC-3)
    # 07:00 BRT = 10:00 UTC
    - cron: '0 10 * * *'  # 07:00 BRT - Bom dia
    # 09:00 BRT = 12:00 UTC
    - cron: '0 12 * * *'  # 09:00 BRT - Hidrataรงรฃo
    # 11:30 BRT = 14:30 UTC
    - cron: '30 14 * * *' # 11:30 BRT - Treino manhรฃ
    # 14:00 BRT = 17:00 UTC
    - cron: '0 17 * * *'  # 14:00 BRT - Hidrataรงรฃo
    # 17:00 BRT = 20:00 UTC
    - cron: '0 20 * * *'  # 17:00 BRT - Treino tarde โญ
    # 19:00 BRT = 22:00 UTC
    - cron: '0 22 * * *'  # 19:00 BRT - Hidrataรงรฃo
    # 21:00 BRT = 00:00 UTC (dia seguinte)
    - cron: '0 0 * * *'   # 21:00 BRT - Boa noite
  
  # Permitir execuรงรฃo manual
  workflow_dispatch:
    inputs:
      notification_type:
        description: 'Tipo de notificaรงรฃo'
        required: true
        default: 'test'
        type: choice
        options:
          - morning
          - hydration
          - workout
          - evening
          - test

jobs:
  send-notification:
    runs-on: ubuntu-latest
    
    steps:
      - name: Identificar horรกrio e tipo de notificaรงรฃo
        id: notification
        run: |
          HOUR=$(date -u +%H)
          
          case $HOUR in
            10) TYPE="morning"; TITLE="๐ช Bom dia, atleta!"; BODY="Hora de comeรงar o dia com energia! Vamos treinar hoje?"; URL="/dashboard" ;;
            12) TYPE="hydration"; TITLE="๐ง Hidrataรงรฃo"; BODY="Jรก bebeu รกgua hoje? Mantenha-se hidratado!"; URL="/dashboard/nutrition" ;;
            14) TYPE="workout"; TITLE="๐๏ธ Hora do Treino!"; BODY="Seu treino estรก te esperando. Vamos nessa!"; URL="/dashboard/training" ;;
            17) TYPE="hydration"; TITLE="๐ง Hidrataรงรฃo"; BODY="Continue bebendo รกgua! Seu corpo agradece."; URL="/dashboard/nutrition" ;;
            20) TYPE="workout"; TITLE="๐โโ๏ธ Treino da Tarde!"; BODY="Que tal um treino agora? Vocรช consegue!"; URL="/dashboard/training" ;;
            22) TYPE="hydration"; TITLE="๐ง รltima Hidrataรงรฃo"; BODY="Beba mais รกgua antes de dormir!"; URL="/dashboard/nutrition" ;;
            0)  TYPE="evening"; TITLE="๐ Boa Noite!"; BODY="Descanse bem para conquistar seus objetivos amanhรฃ!"; URL="/dashboard/motivational" ;;
            *)  TYPE="test"; TITLE="๐งช Teste"; BODY="Notificaรงรฃo automรกtica funcionando!"; URL="/dashboard" ;;
          esac
          
          # Se for execuรงรฃo manual, usar input
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TYPE="${{ github.event.inputs.notification_type }}"
            case $TYPE in
              morning) TITLE="๐ช Bom dia, atleta!"; BODY="Hora de comeรงar o dia com energia!"; URL="/dashboard" ;;
              hydration) TITLE="๐ง Hidrataรงรฃo"; BODY="Jรก bebeu รกgua hoje?"; URL="/dashboard/nutrition" ;;
              workout) TITLE="๐๏ธ Treino!"; BODY="Seu treino estรก te esperando!"; URL="/dashboard/training" ;;
              evening) TITLE="๐ Boa Noite!"; BODY="Descanse bem!"; URL="/dashboard/motivational" ;;
              test) TITLE="๐งช Teste Manual"; BODY="GitHub Actions funcionando!"; URL="/dashboard" ;;
            esac
          fi
          
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "body=$BODY" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "๐ Tipo: $TYPE | Tรญtulo: $TITLE"

      - name: Buscar usuรกrios com push ativo
        id: users
        run: |
          # Buscar apenas usuรกrios com push subscription ativa
          echo "๐ Buscando usuรกrios com notificaรงรตes ativas..."
          
          RESPONSE=$(curl -s -X GET \
            "${{ secrets.SUPABASE_URL }}/rest/v1/push_subscriptions?select=user_id" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json")
          
          echo "๐ Resposta do Supabase:"
          echo "$RESPONSE"
          
          # Verificar se houve erro
          if echo "$RESPONSE" | grep -q "message"; then
            echo "โ๏ธ Erro ao buscar usuรกrios. Usando fallback..."
            # Usar user_id padrรฃo como fallback
            RESPONSE='[{"user_id":"45610e6d-f5f5-4540-912d-a5c9a361e20f"}]'
          fi
          
          USER_COUNT=$(echo "$RESPONSE" | jq 'length' 2>/dev/null || echo "0")
          echo "users=$RESPONSE" >> $GITHUB_OUTPUT
          echo "count=$USER_COUNT" >> $GITHUB_OUTPUT
          echo "โ Encontrados: $USER_COUNT usuรกrios com push ativo"

      - name: Enviar notificaรงรตes via API
        env:
          NOTIFICATION_TYPE: ${{ steps.notification.outputs.type }}
          NOTIFICATION_TITLE: ${{ steps.notification.outputs.title }}
          NOTIFICATION_BODY: ${{ steps.notification.outputs.body }}
          NOTIFICATION_URL: ${{ steps.notification.outputs.url }}
          USERS: ${{ steps.users.outputs.users }}
          USER_COUNT: ${{ steps.users.outputs.count }}
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ ENVIANDO NOTIFICAรรES"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Tipo: $NOTIFICATION_TYPE"
          echo "๐ Tรญtulo: $NOTIFICATION_TITLE"
          echo "๐ฌ Mensagem: $NOTIFICATION_BODY"
          echo "๐ URL: $NOTIFICATION_URL"
          echo "๐ฅ Usuรกrios: $USER_COUNT"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          
          SENT_COUNT=0
          FAILED_COUNT=0
          
          # Parse users JSON e enviar para cada um
          echo "$USERS" | jq -r '.[].user_id' 2>/dev/null | while read user_id; do
            if [ ! -z "$user_id" ]; then
              echo "๐ค Enviando para: ${user_id:0:36}"
              
              RESPONSE=$(curl -s -w "\n%{http_code}" -X POST https://ym-sports.vercel.app/api/notify \
                -H "Content-Type: application/json" \
                -d "{
                  \"user_id\": \"$user_id\",
                  \"title\": \"$NOTIFICATION_TITLE\",
                  \"body\": \"$NOTIFICATION_BODY\",
                  \"url\": \"$NOTIFICATION_URL\"
                }")
              
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | head -n-1)
              
              if [ "$HTTP_CODE" = "200" ]; then
                SENT=$(echo "$BODY" | jq -r '.sent // 0' 2>/dev/null || echo "0")
                FAILED=$(echo "$BODY" | jq -r '.failed // 0' 2>/dev/null || echo "0")
                echo "   โ HTTP $HTTP_CODE - Enviadas: $SENT, Falharam: $FAILED"
                SENT_COUNT=$((SENT_COUNT + SENT))
                FAILED_COUNT=$((FAILED_COUNT + FAILED))
              else
                echo "   โ HTTP $HTTP_CODE - Erro: $BODY"
                FAILED_COUNT=$((FAILED_COUNT + 1))
              fi
              
              echo ""
              sleep 1  # Evitar rate limiting
            fi
          done
          
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ RESUMO FINAL"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ Notificaรงรตes enviadas: $SENT_COUNT"
          echo "โ Notificaรงรตes falharam: $FAILED_COUNT"
          echo "๐ฅ Usuรกrios processados: $USER_COUNT"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "๐ Workflow concluรญdo!"

      - name: Log resultado
        if: always()
        run: |
          echo "๐ Resumo da Execuรงรฃo:"
          echo "โฐ Horรกrio UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "๐ Horรกrio BRT: $(TZ=America/Sao_Paulo date '+%Y-%m-%d %H:%M:%S')"
          echo "๐ Tipo: ${{ steps.notification.outputs.type }}"
          echo "๐ Tรญtulo: ${{ steps.notification.outputs.title }}"
          echo "โ Workflow concluรญdo!"

